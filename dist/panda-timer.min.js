/*
 * *****************************************************************************
 * @license
 * Panda Timer <https://github.com/chuot/panda-timer>
 * Copyright (C) 2020 Chrystian Huot
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>
 * ****************************************************************************
 */
class t{get timeLeft(){return Math.max(0,Math.round((this._dateEnd.getTime()-(new Date).getTime())/1e3))}get _centerX(){return this._canvas.width/2}get _centerY(){return this._canvas.height/2}get _height(){return this._canvas.height}get _radius(){return Math.floor(Math.min(this._canvas.height,this._canvas.width)/2*.9)}get _width(){return this._canvas.width}constructor(i={},e=document.getElementById("panda-timer")){if(!(e instanceof HTMLCanvasElement))return console.warn("canvas#panda-timer not found"),{};this._audioContext=null,this._canvas=e,(i=null!==i&&"object"==typeof i?i:{}).color=null!==i.color&&"object"==typeof i.color?i.color:{},i.text=null!==i.text&&"object"==typeof i.text?i.text:{};const s=parseInt(`${i.timeLeft}`);this._config={alterable:"boolean"==typeof i.alterable?i.alterable:t.defaultConfig.alterable,autostart:"boolean"==typeof i.autostart?i.autostart:t.defaultConfig.autostart,color:{background:"string"==typeof i.color.background?i.color.background:t.defaultConfig.color.background,cursor:"string"==typeof i.color.cursor?i.color.cursor:t.defaultConfig.color.cursor,face:"string"==typeof i.color.face?i.color.face:t.defaultConfig.color.face,panda:"string"==typeof i.color.panda?i.color.panda:t.defaultConfig.color.panda,scale:"string"==typeof i.color.scale?i.color.scale:t.defaultConfig.color.scale,text:"string"==typeof i.color.text?i.color.text:t.defaultConfig.color.text,timer:"string"==typeof i.color.timer?i.color.timer:t.defaultConfig.color.timer},font:"string"==typeof i.font?i.font:t.defaultConfig.font,indexed:"boolean"==typeof i.indexed?i.indexed:t.defaultConfig.indexed,text:{line1:"string"==typeof i.text.line1?i.text.line1:t.defaultConfig.text.line1,line2:"string"==typeof i.text.line2?i.text.line2:t.defaultConfig.text.line2},timeLeft:isNaN(s)?t.defaultConfig.timeLeft:s,timeMax:parseInt(`${i.timeMax}`)||t.defaultConfig.timeMax},this._ctx=e&&e.getContext("2d"),this._cursorMoving=!1,this._cursorPrevious=null,this._dateEnd=null,this._intervalHandle=null,this._responsive=!this._canvas.attributes.getNamedItem("height")&&!this._canvas.attributes.getNamedItem("width"),this._subscriptions=[],this._bootstrap(),this.setTimeLeft(this._config.timeLeft),this._responsive&&(this._resize(),window.addEventListener("resize",(()=>{this._resize(),this._draw()}))),this._draw(),this._config.alterable&&(["mousedown","touchstart"].forEach((t=>this._canvas.addEventListener(t,(t=>this._onTouch(t))))),["mousemove","touchmove"].forEach((t=>this._canvas.addEventListener(t,(t=>this._onMove(t))))),["mouseleave","mouseup","touchend"].forEach((t=>this._canvas.addEventListener(t,(()=>this._onRelease()))))),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&(this.intervalHandle?this.start():this._draw(),this._audioContext&&setTimeout((()=>this._audioContext.resume()),100))})),window.addEventListener("beforeunload",(t=>{this._intervalHandle&&(t.preventDefault(),t.returnValue="")})),this._config.autostart&&this.start()}setTimeLeft(t){"number"==typeof t&&(this._dateEnd=new Date,this._dateEnd.setSeconds(this._dateEnd.getSeconds()+t),this._draw())}start(t){"number"==typeof timeleft&&this.setTimeLeft(t);const i="visible"===document.visibilityState?1:1e4;this._intervalHandle&&(clearInterval(this._intervalHandle),this._tick(),this._draw()),this._intervalHandle=setInterval((()=>{this._tick(),this.timeLeft<=0?(clearInterval(this._intervalHandle),this._intervalHandle=null,this._playCompleted()):this.timeLeft%300||this._playReminder(),this._draw()}),1e3*i)}stop(){this._intervalHandle&&(clearInterval(this._intervalHandle),this._intervalHandle=null)}subscribe(t,i=0){const e={unsubscribe:()=>{const t=this._subscriptions.find((t=>t===e));return-1!==t&&(this._subscriptions.splice(t,1),!0)},get _callback(){return"function"==typeof t?t:()=>{}},get _timeLeft(){return Math.round(i)}};return this._subscriptions.push(e),e}_bootstrap(){const t=["keydown","mousedown","touchstart"],i=()=>{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)),this._audioContext&&(this._audioContext.resume(),t.forEach((t=>document.body.removeEventListener(t,i))))};t.forEach((t=>document.body.addEventListener(t,i)))}_draw(){this._drawBackground(),this._drawFace(),this._drawTicks(),this._drawTimeLeft(),this._drawPanda(),this._config.alterable&&this._drawCursor(),this._drawNumbers(),this._drawText()}_drawBackground(){this._ctx.rect(0,0,this._width,this._height),this._ctx.fillStyle=this._config.color.background,this._ctx.fill()}_drawCursor(){const t=2*Math.PI/this._config.timeMax*(this._config.timeMax-this.timeLeft);this._ctx.beginPath(),this._ctx.translate(this._centerX+.8*this._radius*Math.sin(t),this._centerY+-.8*this._radius*Math.cos(t)),this._ctx.moveTo(0,0),this._ctx.rotate(t),this._ctx.lineTo(-.1*this._radius,-.1*this._radius),this._ctx.arcTo(-.1*this._radius,-.2*this._radius,0,-.2*this._radius,.1*this._radius),this._ctx.arcTo(.1*this._radius,-.2*this._radius,.1*this._radius,-.1*this._radius,.1*this._radius),this._ctx.lineTo(0,0),this._ctx.fillStyle=this._config.color.cursor,this._ctx.fill(),this._ctx.rotate(-t),this._ctx.translate(-this._centerX+-.8*this._radius*Math.sin(t),-this._centerY+.8*this._radius*Math.cos(t))}_drawFace(){this._ctx.beginPath(),this._ctx.arc(this._centerX,this._centerY,1.1*this._radius,0,2*Math.PI),this._ctx.fillStyle=this._config.color.face,this._ctx.fill()}_drawNumbers(){if(this._config.timeMax<720)return;const t=this._config.timeMax/60/12;this._ctx.font=`bold ${this._radius*(this._config.timeMax>3600?.1:.15)}px ${this._config.font}`,this._ctx.textBaseline="middle",this._ctx.textAlign="center";for(let i=0;i<12;i++){const e=i*Math.PI/-6,s=`${Math.floor(i*t)}`;this._ctx.fillStyle=[1,2,6,10,11].includes(i)?this._config.color.face:this._config.color.scale,this._ctx.translate(this._centerX,this._centerY),this._ctx.beginPath(),this._ctx.rotate(e),this._ctx.translate(0,-.925*this._radius),this._ctx.rotate(-e),this._ctx.fillText(s,0,0),this._ctx.rotate(e),this._ctx.translate(0,.925*this._radius),this._ctx.rotate(-e),this._ctx.translate(-this._centerX,-this._centerY)}}_drawPanda(){this._ctx.fillStyle=this._config.color.panda,this._ctx.translate(this._centerX,this._centerY),this._ctx.beginPath(),this._ctx.rotate(-.25*Math.PI),this._ctx.arc(0,-.95*this._radius,.4*this._radius,.875*Math.PI,.125*Math.PI),this._ctx.fill(),this._ctx.rotate(.25*Math.PI),this._ctx.beginPath(),this._ctx.rotate(.25*Math.PI),this._ctx.arc(0,-.95*this._radius,.4*this._radius,.875*Math.PI,.125*Math.PI),this._ctx.fill(),this._ctx.rotate(-.25*Math.PI),this._ctx.beginPath(),this._ctx.ellipse(-.35*this._radius,0,.25*this._radius,.4*this._radius,.1*Math.PI,0,2*Math.PI),this._ctx.ellipse(.35*this._radius,0,.25*this._radius,.4*this._radius,-.1*Math.PI,0,2*Math.PI),this._ctx.fill(),this._ctx.beginPath(),this._ctx.arc(0,.85*this._radius,.2*this._radius,1.925*Math.PI,1.075*Math.PI),this._ctx.fill(),this._ctx.translate(-this._centerX,-this._centerY)}_drawText(){if(this._ctx.beginPath(),this._ctx.fillStyle=this._config.color.text,this._ctx.textBaseline="middle",this._ctx.textAlign="center",this._cursorMoving){const t=this.timeLeft,i=this._config.timeMax>=3600?`${Math.floor(t/3600)}h`:"",e=`${Math.floor(t%3600/60)}m`.replace(/^([0-9]m)/,"0$1"),s=(t%60+"s").replace(/^([0-9]s)/,"0$1");this._ctx.font=.06*this._radius+"px monospace",this._ctx.fillText(`${i} ${e} ${s}`,this._centerX,this._centerY+.45*this._radius)}else this._ctx.font=`${.05*this._radius}px ${this._config.font}`,this._config.text.line1&&this._config.text.line2?(this._ctx.fillText(this._config.text.line1,this._centerX,this._centerY+.425*this._radius),this._ctx.fillText(this._config.text.line2,this._centerX,this._centerY+.475*this._radius)):this._ctx.fillText(this._config.text.line1||this._config.text.line2,this._centerX,this._centerY+.45*this._radius)}_drawTicks(){for(let t=0;t<30;t++){const i=t*Math.PI/30,e=this._radius*(t%5?.7:.6),s=.8*this._radius,a=t%5?1:3;this._ctx.translate(this._centerX,this._centerY),this._ctx.beginPath(),this._ctx.moveTo(0,0),this._ctx.rotate(i),this._ctx.moveTo(0,e),this._ctx.lineTo(0,s),this._ctx.moveTo(0,-e),this._ctx.lineTo(0,-s),this._ctx.lineWidth=a,this._ctx.strokeStyle=this._config.color.scale,this._ctx.stroke(),this._ctx.rotate(-i),this._ctx.translate(-this._centerX,-this._centerY)}}_drawTimeLeft(){const t=2*Math.PI/this._config.timeMax*(this._config.timeMax-this.timeLeft)-.5*Math.PI;this._ctx.translate(this._centerX,this._centerY),this._ctx.fillStyle=this._config.color.timer,this._ctx.beginPath(),this._ctx.moveTo(0,0),this._ctx.arc(0,0,.8*this._radius,t,1.5*Math.PI),this._ctx.lineTo(0,0),this._ctx.fill(),this._ctx.beginPath(),this._ctx.arc(0,0,.025*this._radius,0,2*Math.PI),this._ctx.shadowBlur=.01*this._radius,this._ctx.shadowColor="#333",this._ctx.fill(),this._ctx.shadowBlur=0,this._ctx.translate(-this._centerX,-this._centerY)}_onMove(t){if(!this._cursorMoving)return;const i=t.touches?t.touches[0].pageX:t.pageX,e=t.touches?t.touches[0].pageY:t.pageY,s=i-(t.target.clientLeft+t.target.offsetLeft)-this._centerX,a=e-(t.target.clientTop+t.target.offsetTop)-this._centerY;let o=Math.atan2(a,s)+.5*Math.PI;o<0&&(o+=2*Math.PI);let n=Math.round(this._config.timeMax-this._config.timeMax/(2*Math.PI)*o);this._config.indexed&&(n=60*Math.round(n/60)),Math.abs(n-this._cursorPrevious)<this._config.timeMax/2&&(this._cursorPrevious=n,this.setTimeLeft(n))}_onRelease(){this._cursorMoving&&(this._cursorMoving=!1,this._draw(),this._config.autostart&&this.start())}_onTouch(t){const i=2*Math.PI/this._config.timeMax*(this._config.timeMax-this.timeLeft)-.5*Math.PI,e=this._centerX+.925*this._radius*Math.cos(i),s=this._centerY+.925*this._radius*Math.sin(i),a=t.touches?t.touches[0].pageX:t.pageX,o=t.touches?t.touches[0].pageY:t.pageY,n=a-(t.target.clientLeft+t.target.offsetLeft),h=o-(t.target.clientTop+t.target.offsetTop);this._cursorMoving=Math.sqrt((e-n)**2+(s-h)**2)<=.15*this._radius,this._cursorMoving&&(t.preventDefault(),this._cursorPrevious=this.timeLeft,this.stop())}_playCompleted(){this._audioContext&&this._audioContext.resume().then((()=>{const t=this._audioContext.createGain(),i=this._audioContext.createOscillator(),e=this._audioContext.createOscillator();t.gain.value=1,t.connect(this._audioContext.destination),i.frequency.value=2050,i.connect(t),i.start(this._audioContext.currentTime),i.stop(this._audioContext.currentTime+.125),e.frequency.value=2050,e.connect(t),e.start(this._audioContext.currentTime+.25),e.stop(this._audioContext.currentTime+.35)}))}_playReminder(){this._audioContext&&this._audioContext.resume().then((()=>{const t=this._audioContext.createOscillator(),i=this._audioContext.createGain();i.gain.value=.5,i.connect(this._audioContext.destination),t.frequency.value=1850,t.connect(i),t.start(this._audioContext.currentTime),t.stop(this._audioContext.currentTime+.125)}))}_resize(){this._responsive&&(this._canvas.height=this._canvas.width=Math.min(this._canvas.parentElement.clientHeight,this._canvas.parentElement.clientWidth))}_tick(){const t=this.timeLeft;this._subscriptions.forEach((i=>{t===i._timeLeft&&i._callback(t)}))}}t.defaultConfig={alterable:!0,autostart:!0,color:{background:"#fff",cursor:"rgba(255, 0, 0, 0.3)",face:"#fff",panda:"#333",scale:"#333",text:"#333",timer:"#f00"},font:"arial",indexed:!0,text:{line1:"Panda Timer",line2:""},timeLeft:0,timeMax:3600},void 0!==window&&(window.PandaTimer=t);