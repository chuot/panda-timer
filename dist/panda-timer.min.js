/*
 * *****************************************************************************
 * @license
 * Panda Timer <https://github.com/chuot/panda-timer>
 * Copyright (C) 2022 Chrystian Huot <chrystian.huot@saubeo.solutions>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>
 * ****************************************************************************
 */
class PandaTimer{get timeLeft(){return Math.max(0,Math.round((this.#t.getTime()-(new Date).getTime())/1e3))}get#i(){return this.#e.getBoundingClientRect()}get#s(){return this.#e.width/2}get#a(){return this.#e.height/2}get#n(){return this.#e.height}get#o(){return Math.floor(Math.min(this.#e.height,this.#e.width)/2*.9)}get#h(){return this.#e.width}#r;#c;#e;#d;#l;#u;#x;#t;#f;#m=[];constructor(t=document.getElementById("panda-timer"),i){if(!(t instanceof HTMLCanvasElement))throw Error("canvas is not an instanceof HTMLCanvasElement");this.#e=t,this.#d={alterable:"boolean"==typeof i?.alterable?i.alterable:PandaTimer.defaultConfig.alterable,autostart:"boolean"==typeof i?.autostart?i.autostart:PandaTimer.defaultConfig.autostart,color:{background:"string"==typeof i?.color?.background?i.color.background:PandaTimer.defaultConfig.color.background,cursor:"string"==typeof i?.color?.cursor?i.color.cursor:PandaTimer.defaultConfig.color.cursor,face:"string"==typeof i?.color?.face?i.color.face:PandaTimer.defaultConfig.color.face,panda:"string"==typeof i?.color?.panda?i.color.panda:PandaTimer.defaultConfig.color.panda,scale:"string"==typeof i?.color?.scale?i.color.scale:PandaTimer.defaultConfig.color.scale,text:"string"==typeof i?.color?.text?i.color.text:PandaTimer.defaultConfig.color.text,timer:"string"==typeof i?.color?.timer?i.color.timer:PandaTimer.defaultConfig.color.timer},font:"string"==typeof i?.font?i.font:PandaTimer.defaultConfig.font,indexed:"boolean"==typeof i?.indexed?i.indexed:PandaTimer.defaultConfig.indexed,reminders:"boolean"==typeof i?.reminders?i.reminders:PandaTimer.defaultConfig.reminders,text:{line1:"string"==typeof i?.text?.line1?i.text.line1:PandaTimer.defaultConfig.text.line1,line2:"string"==typeof i?.text?.line2?i.text.line2:PandaTimer.defaultConfig.text.line2},timeLeft:Math.max(0,parseInt(`${i?.timeLeft}`))||PandaTimer.defaultConfig.timeLeft,timeMax:Math.max(0,parseInt(`${i?.timeMax}`))||PandaTimer.defaultConfig.timeMax},this.#l=t&&t.getContext("2d"),this.#g(),this.setTimeLeft(this.#d.timeLeft),this.#v(),this.#M(),this.#d.alterable&&(this.#e.addEventListener("mousedown",this),this.#e.addEventListener("touchstart",this),this.#e.addEventListener("touchmove",this),this.#e.addEventListener("touchend",this)),document.addEventListener("visibilitychange",this),window.addEventListener("beforeunload",this),window.addEventListener("unload",this),window.addEventListener("resize",this),this.#d.autostart&&this.start()}handleEvent(t){switch(t.type){case"mousedown":case"touchstart":this.#b(t);break;case"mousemove":case"touchmove":this.#p(t);break;case"mouseup":case"touchend":this.#P(t);break;case"resize":this.#v(),this.#M();break;case"beforeunload":this.#C(t);break;case"unload":this.stop();break;case"visibilitychange":this.#T()}}setTimeLeft(t){"number"==typeof t&&(this.#t=new Date,this.#t.setSeconds(this.#t.getSeconds()+t),this.#M())}start(t){"number"==typeof t&&this.setTimeLeft(t),this.timeLeft?(this.#f&&(clearInterval(this.#f),this.#w(),this.#M()),this.#f=setInterval((()=>{this.#w(),this.timeLeft<=0?(clearInterval(this.#f),this.#f=null,this.#y()):this.#d.reminders&&(this.timeLeft%300||this.#L()),this.#M()}),1e3)):this.#y()}stop(){this.#f&&(clearInterval(this.#f),this.#f=null)}subscribe(t,i=0){const e={unsubscribe:()=>{const t=this.#m.find((t=>t===e));return-1!==t&&(this.#m.splice(t,1),!0)},get callback(){return"function"==typeof t?t:()=>{}},get timeLeft(){return Math.round(i)}};return this.#m.push(e),e}#g(){const t=["keydown","mousedown","touchstart"],i=()=>{this.#r||(this.#r=new(window.AudioContext||window.webkitAudioContext)),this.#r&&("suspended"===this.#r.state&&this.#r.resume(),t.forEach((t=>document.body.removeEventListener(t,i))))};t.forEach((t=>document.body.addEventListener(t,i)))}#C(t){this.#f&&(t.preventDefault(),t.returnValue="")}#M(){this.#I(),this.#E(),this.#k(),this.#X(),this.#Y(),this.#d.alterable&&this.#B(),this.#$(),this.#H()}#I(){this.#l.rect(0,0,this.#h,this.#n),this.#l.fillStyle=this.#d.color.background,this.#l.fill()}#B(){const t=2*Math.PI/this.#d.timeMax*(this.#d.timeMax-this.timeLeft);this.#l.beginPath(),this.#l.translate(this.#s+.8*this.#o*Math.sin(t),this.#a+-.8*this.#o*Math.cos(t)),this.#l.moveTo(0,0),this.#l.rotate(t),this.#l.lineTo(-.1*this.#o,-.1*this.#o),this.#l.arcTo(-.1*this.#o,-.2*this.#o,0,-.2*this.#o,.1*this.#o),this.#l.arcTo(.1*this.#o,-.2*this.#o,.1*this.#o,-.1*this.#o,.1*this.#o),this.#l.lineTo(0,0),this.#l.fillStyle=this.#d.color.cursor,this.#l.fill(),this.#l.rotate(-t),this.#l.translate(-this.#s+-.8*this.#o*Math.sin(t),-this.#a+.8*this.#o*Math.cos(t))}#E(){this.#l.beginPath(),this.#l.arc(this.#s,this.#a,1.1*this.#o,0,2*Math.PI),this.#l.fillStyle=this.#d.color.face,this.#l.fill()}#$(){if(this.#d.timeMax<720)return;const t=this.#d.timeMax/60/12;this.#l.font=`bold ${this.#o*(this.#d.timeMax>3600?.1:.15)}px ${this.#d.font}`,this.#l.textBaseline="middle",this.#l.textAlign="center";for(let i=0;i<12;i++){const e=i*Math.PI/-6,s=`${Math.floor(i*t)}`;this.#l.fillStyle=[1,2,6,10,11].includes(i)?this.#d.color.face:this.#d.color.scale,this.#l.translate(this.#s,this.#a),this.#l.beginPath(),this.#l.rotate(e),this.#l.translate(0,-.925*this.#o),this.#l.rotate(-e),this.#l.fillText(s,0,0),this.#l.rotate(e),this.#l.translate(0,.925*this.#o),this.#l.rotate(-e),this.#l.translate(-this.#s,-this.#a)}}#Y(){this.#l.fillStyle=this.#d.color.panda,this.#l.translate(this.#s,this.#a),this.#l.beginPath(),this.#l.rotate(-.25*Math.PI),this.#l.arc(0,-.95*this.#o,.4*this.#o,.875*Math.PI,.125*Math.PI),this.#l.fill(),this.#l.rotate(.25*Math.PI),this.#l.beginPath(),this.#l.rotate(.25*Math.PI),this.#l.arc(0,-.95*this.#o,.4*this.#o,.875*Math.PI,.125*Math.PI),this.#l.fill(),this.#l.rotate(-.25*Math.PI),this.#l.beginPath(),this.#l.ellipse(-.35*this.#o,0,.25*this.#o,.4*this.#o,.1*Math.PI,0,2*Math.PI),this.#l.ellipse(.35*this.#o,0,.25*this.#o,.4*this.#o,-.1*Math.PI,0,2*Math.PI),this.#l.fill(),this.#l.beginPath(),this.#l.arc(0,.85*this.#o,.2*this.#o,1.925*Math.PI,1.075*Math.PI),this.#l.fill(),this.#l.translate(-this.#s,-this.#a)}#H(){if(this.#l.beginPath(),this.#l.fillStyle=this.#d.color.text,this.#l.textBaseline="middle",this.#l.textAlign="center",this.#u){const t=this.timeLeft,i=this.#d.timeMax>=3600?`${Math.floor(t/3600)}h`:"",e=`${Math.floor(t%3600/60)}m`.replace(/^([0-9]m)/,"0$1"),s=(t%60+"s").replace(/^([0-9]s)/,"0$1");this.#l.font=.06*this.#o+"px monospace",this.#l.fillText(`${i} ${e} ${s}`,this.#s,this.#a+.45*this.#o)}else this.#l.font=`${.05*this.#o}px ${this.#d.font}`,this.#d.text.line1&&this.#d.text.line2?(this.#l.fillText(this.#d.text.line1,this.#s,this.#a+.425*this.#o),this.#l.fillText(this.#d.text.line2,this.#s,this.#a+.475*this.#o)):this.#l.fillText(this.#d.text.line1||this.#d.text.line2,this.#s,this.#a+.45*this.#o)}#k(){for(let t=0;t<30;t++){const i=t*Math.PI/30,e=this.#o*(t%5?.7:.6),s=.8*this.#o,a=t%5?1:3;this.#l.translate(this.#s,this.#a),this.#l.beginPath(),this.#l.moveTo(0,0),this.#l.rotate(i),this.#l.moveTo(0,e),this.#l.lineTo(0,s),this.#l.moveTo(0,-e),this.#l.lineTo(0,-s),this.#l.lineWidth=a,this.#l.strokeStyle=this.#d.color.scale,this.#l.stroke(),this.#l.rotate(-i),this.#l.translate(-this.#s,-this.#a)}}#X(){const t=2*Math.PI/this.#d.timeMax*(this.#d.timeMax-this.timeLeft)-.5*Math.PI;this.#l.translate(this.#s,this.#a),this.#l.fillStyle=this.#d.color.timer,this.#l.beginPath(),this.#l.moveTo(0,0),this.#l.arc(0,0,.8*this.#o,t,1.5*Math.PI),this.#l.lineTo(0,0),this.#l.fill(),this.#l.beginPath(),this.#l.arc(0,0,.025*this.#o,0,2*Math.PI),this.#l.shadowBlur=.01*this.#o,this.#l.shadowColor="#333",this.#l.fill(),this.#l.shadowBlur=0,this.#l.translate(-this.#s,-this.#a)}#p(t){if(!this.#u)return;const i=t.touches?t.touches[0].clientX:t.clientX,e=t.touches?t.touches[0].clientY:t.clientY,s=i-this.#i.x-this.#s,a=e-this.#i.y-this.#a;let n=Math.atan2(a,s)+.5*Math.PI;n<0&&(n+=2*Math.PI);let o=Math.round(this.#d.timeMax-this.#d.timeMax/(2*Math.PI)*n);if(this.#d.indexed){const t=this.#d.timeMax/60;o=Math.round(o/t)*t}Math.abs(o-this.#x)<this.#d.timeMax/2&&(this.#x=o,this.setTimeLeft(o))}#P(t){t.touches||(document.removeEventListener("mousemove",this),document.removeEventListener("mouseup",this)),this.#u&&(this.#u=!1,this.#M(),this.timeLeft?this.#d.autostart&&this.start():this.#y())}#b(t){t.touches||(document.addEventListener("mousemove",this),document.addEventListener("mouseup",this));const i=2*Math.PI/this.#d.timeMax*(this.#d.timeMax-this.timeLeft)-.5*Math.PI,e=this.#s+.925*this.#o*Math.cos(i),s=this.#a+.925*this.#o*Math.sin(i),a=t.touches?t.touches[0].clientX:t.clientX,n=t.touches?t.touches[0].clientY:t.clientY,o=a-this.#i.x,h=n-this.#i.y;this.#u=Math.sqrt((e-o)**2+(s-h)**2)<=.15*this.#o,this.#u&&(t.preventDefault(),this.#x=this.timeLeft,this.#M(),this.stop())}#T(){"visible"===document.visibilityState&&this.#r&&"suspended"===this.#r.state&&this.#r.resume()}#y(){if(this.#r&&!this.#c){this.#c=!0;const t=this.#r.createGain(),i=this.#r.createOscillator(),e=this.#r.createOscillator();t.gain.value=1,t.connect(this.#r.destination),i.frequency.value=2050,i.connect(t),i.start(this.#r.currentTime),i.stop(this.#r.currentTime+.125),e.frequency.value=2050,e.connect(t),e.start(this.#r.currentTime+.25),e.stop(this.#r.currentTime+.35),e.onended=()=>this.#c=!1}}#L(){if(this.#r&&!this.#c){this.#c=!0;const t=this.#r.createOscillator(),i=this.#r.createGain();i.gain.value=.1,i.connect(this.#r.destination),t.frequency.value=1850,t.connect(i),t.start(this.#r.currentTime),t.stop(this.#r.currentTime+.125),t.onended=()=>this.#c=!1}}#v(){this.#e.height=this.#e.clientHeight,this.#e.width=this.#e.clientWidth}#w(){const t=this.timeLeft;this.#m.forEach((i=>{t===i.timeLeft&&i.callback(t)}))}}PandaTimer.defaultConfig={alterable:!0,autostart:!0,color:{background:"#fff",cursor:"rgba(255, 51, 51, 0.3)",face:"#fff",panda:"#333",scale:"#333",text:"#333",timer:"#f33"},font:"arial",indexed:!0,reminders:!0,text:{line1:"Panda Timer",line2:""},timeLeft:0,timeMax:3600};